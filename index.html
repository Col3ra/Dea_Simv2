<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>DEA – Prototipo móvil (landscape)</title>
<meta name="theme-color" content="#050915" />
<style>
:root{
  --bg:#050915; --panel:#0b1220; --line:#1f2a44; --txt:#e6edf7; --muted:#95a3bd;
  --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.02);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--txt);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  background: radial-gradient(1200px 800px at 10% -10%, #0b1730 0%, #060b16 50%, var(--bg) 100%),
              linear-gradient(140deg, #07122a 0%, #050915 60%, #04070e 100%);
}

/* Layout fijo a viewport para que nada “empuje” */
.app{
  height:100dvh;
  padding:clamp(6px,1.2vw,14px);
  display:grid; gap:clamp(8px,1.2vw,14px);
  grid-template-columns: 1.05fr 1fr;
  min-height:0;
}

/* Izquierda: header + LCD + info + INDICACIÓN ACTUAL */
.left{ display:grid; grid-template-rows:auto auto auto 1fr; gap:8px; min-height:0 }
.box{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--line); border-radius:16px; padding:10px; box-shadow:var(--shadow);
  min-height:0;
}
.headerRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#cbd5e1}

/* LCD solamente para animación (texto siempre oculto) */
.lcd{
  position:relative; overflow:hidden;
  background:linear-gradient(180deg,#0e1a33 0%, #0a1326 60%, #08101d 100%);
  border:1px solid #1d2840; border-radius:12px; padding:10px; min-height:120px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
  display:flex; align-items:center; justify-content:center;
}
#ekg{ position:absolute; inset:0; width:100%; height:100%; z-index:1; opacity:.95 }
.lcd .text{ display:none } /* <- ya no mostramos texto encima del LCD */

/* Info pills */
.infoRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;color:var(--muted)}
.pill{padding:5px 9px;border:1px solid var(--line);border-radius:999px;background:#0b1220;font-size:12px}
.countdown{font-variant-numeric:tabular-nums;font-weight:900;letter-spacing:.3px;font-size:clamp(16px,2.2vw,22px)}

/* INDICACIÓN ACTUAL (solo una frase) */
.indicacion{
  display:flex; align-items:center; min-height:0;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:var(--shadow);
}
#indicacionTxt{
  font-size:clamp(16px,2.2vw,22px);
  line-height:1.25;
  color:#e9effa;
}

/* Derecha: botonera estable */
.right{ min-height:0 }
.right.box{ display:flex; flex-direction:column }
.gridBtns{
  display:grid; gap:8px;
  grid-template-columns: repeat(3, 1fr);
  grid-auto-rows: minmax(60px, 1fr);
  flex:1;
  pointer-events:auto;
}
.btn{
  -webkit-tap-highlight-color:transparent; user-select:none; cursor:pointer; border:0;
  padding:10px; border-radius:14px; text-align:center;
  color:#0b1020; font-weight:900; letter-spacing:.3px; position:relative; overflow:hidden;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
}
.btn .label{ font-size:clamp(13px,1.7vw,18px); line-height:1.05; overflow-wrap:anywhere }
.btn .sub{ font-size:11px; opacity:.9; color:#041019 }
.btn:active{ transform: scale(.99) }
.btn[disabled]{ filter:saturate(.4) brightness(.86); opacity:.6; box-shadow:none }

/* FULLSCREEN último siempre */
.btn.full{ order:99 }

/* Fondos */
.btn.power{background:conic-gradient(from 210deg at 30% 0%, #82ffd6 0deg, #3ddcff 120deg, #b694ff 240deg, #82ffd6 360deg); box-shadow:0 10px 30px rgba(0,245,160,.22)}
.btn.pads{background:linear-gradient(160deg,#7af59a,#22d3ee); box-shadow:0 10px 30px rgba(34,211,238,.28)}
.btn.analyze{background:linear-gradient(160deg,#3ddcff,#b694ff); box-shadow:0 10px 30px rgba(61,220,255,.26)}
.btn.nobody{background:linear-gradient(160deg,#ffb4b4,#ff6a6a); box-shadow:0 10px 30px rgba(255,90,90,.30)}
.btn.shock{background:linear-gradient(160deg,#ffe08a,#ff7b00); box-shadow:0 10px 30px rgba(255,180,80,.30)}
.btn.cpr{background:linear-gradient(160deg,#7af59a,#22d3ee); box-shadow:0 10px 30px rgba(34,211,238,.28)}
.btn.full{background:linear-gradient(160deg,#9b5cf6,#22d3ee); box-shadow:0 10px 30px rgba(155,92,246,.28)}

/* Overlays (no bloquean ocultos) */
.modal, .rotateOverlay, #flash{
  position:fixed; inset:0; display:none; place-items:center; z-index:9999; pointer-events:none;
}
.rotateOverlay{ background:rgba(5,9,21,.9); color:#fff; text-align:center; padding:24px; font-size:clamp(16px,3vw,20px) }
.rotateOverlay.show{ display:grid; pointer-events:auto }
.modal{ background:rgba(5,9,21,.88); color:#fff; text-align:left; padding:18px }
.modal.show{ display:grid; pointer-events:auto }
.modalCard{ max-width:560px; width:92%; background:#0b1220; border:1px solid var(--line); border-radius:12px; padding:14px }
.modal .btnClose{ background:#172036; color:#e6edf7; padding:10px 12px; border-radius:12px; border:1px solid #22304e }

/* SHOCK WOW – “edge-in flash”: blanco desde bordes hacia el centro */
#flash{ pointer-events:none }
#flash.show::before{
  content:""; position:fixed; inset:0; background:#ffffff;
  /* hueco circular central que se cierra (de grande a pequeño) */
  -webkit-mask: radial-gradient(circle at 50% 50%, transparent 55%, black 56%);
          mask: radial-gradient(circle at 50% 50%, transparent 55%, black 56%);
  animation: edgeIn .5s ease-out forwards;
}
@keyframes edgeIn{
  0%   { opacity:0 }
  10%  { opacity:1; -webkit-mask-size: 250% 250%; mask-size:250% 250% } /* borde apenas entra */
  60%  { opacity:1; -webkit-mask-size: 30% 30%;  mask-size:30% 30% }    /* se cierra hacia el centro */
  100% { opacity:0; -webkit-mask-size: 0% 0%;    mask-size:0% 0% }      /* desaparece */
}

@media (orientation: portrait){ .app{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="rotateOverlay" id="rotateOverlay">Girá el teléfono a <b>horizontal</b> para usar el simulador.</div>

<!-- Modal iPhone fullscreen -->
<div class="modal" id="fsModal">
  <div class="modalCard">
    <h3>Pantalla completa en iPhone</h3>
    <ol>
      <li>Compartir → <b>Añadir a pantalla de inicio</b>.</li>
      <li>Abrir desde el Home para <b>full screen</b>.</li>
    </ol>
    <p><i>Aplico pseudo-fullscreen mientras tanto.</i></p>
    <button class="btn btnClose" id="fsClose"><span class="label">Entendido</span></button>
  </div>
</div>

<!-- Flash WOW -->
<div id="flash"></div>

<div class="app">
  <!-- IZQUIERDA -->
  <section class="left">
    <div class="box headerRow">
      <span class="badge">DEA</span>
      <span class="badge" id="modeTag">Prototipo</span>
      <span class="badge" id="cycleTag">Ciclo: 0</span>
    </div>

    <div class="box">
      <div class="lcd">
        <canvas id="ekg"></canvas>
        <div class="text" id="lcdText"> <!-- intencionalmente vacío/oculto --> </div>
      </div>
      <div class="infoRow">
        <div class="pill" id="padsPill">Parches: —</div>
        <div class="pill" id="safePill">Seguridad: —</div>
        <div class="pill">Energía: <b id="energy">—</b></div>
        <div class="pill countdown" id="clock">00:00</div>
      </div>
    </div>

    <!-- INDICACIÓN ACTUAL -->
    <div class="indicacion"><div id="indicacionTxt">Encienda el equipo.</div></div>
  </section>

  <!-- DERECHA -->
  <section class="right box">
    <div class="gridBtns">
      <button class="btn power" id="btnPower"><span class="label">POWER</span><span class="sub">Encender / Reiniciar</span></button>
      <button class="btn pads" id="btnPads" disabled><span class="label">PARCHES OK</span><span class="sub">Confirmar</span></button>
      <button class="btn analyze" id="btnAnalyze" disabled><span class="label">ANALIZAR</span><span class="sub">Evaluar ritmo</span></button>
      <button class="btn nobody" id="btnNobody" disabled><span class="label">¡NADIE TOQUE!</span><span class="sub">Seguridad</span></button>
      <button class="btn shock" id="btnShock" disabled><span class="label">SHOCK</span><span class="sub">Descarga</span></button>
      <button class="btn cpr" id="btnCPR" disabled><span class="label">RCP 2:00</span><span class="sub">Metrónomo 110</span></button>
      <button class="btn full" id="btnFull"><span class="label">FULLSCREEN</span><span class="sub">Ocultar barras</span></button>
      <button class="btn" disabled style="opacity:.35;background:linear-gradient(160deg,#1d2435,#121a2a)"><span class="label">—</span><span class="sub">Reservado</span></button>
    </div>
  </section>
</div>

<script defer>
document.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);
  const indic = $('#indicacionTxt');

  const lcdText=$('#lcdText'), energyEl=$('#energy'), cycleTag=$('#cycleTag');
  const btnPower=$('#btnPower'), btnFull=$('#btnFull'), btnPads=$('#btnPads'), btnAnalyze=$('#btnAnalyze');
  const btnNobody=$('#btnNobody'), btnShock=$('#btnShock'), btnCPR=$('#btnCPR');
  const padsPill=$('#padsPill'), safePill=$('#safePill'), clockEl=$('#clock');
  const rotateOverlay=$('#rotateOverlay'), fsModal=$('#fsModal'), fsClose=$('#fsClose'), flashEl=$('#flash');

  const State={ OFF:'off', WAIT_PADS:'wait_pads', ANALYZING:'analyzing', CHARGING:'charging', SHOCK_READY:'shock_ready', CPR:'cpr', READY:'ready' };
  let sim={ state:State.OFF, cycle:0, padsOk:false, safe:false, firstAnalysis:true, energy:200, timers:{an:null,ch:null,cpr:null,metro:null,ekg:null} };

  function setInstruction(txt){ indic.textContent = txt; }
  function checkOrientation(){ const p=matchMedia('(orientation: portrait)').matches; rotateOverlay.classList.toggle('show', p); }
  checkOrientation(); addEventListener('orientationchange',checkOrientation); addEventListener('resize',checkOrientation);

  function speak(txt){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(txt); const vs=speechSynthesis.getVoices(); u.voice=vs.find(v=>v.lang?.startsWith('es'))||null; u.lang=u.voice?.lang||'es-AR'; u.rate=1; u.pitch=1; try{ speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }

  function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent)|| (navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1); }
  async function goFullscreen(){
    try{
      if(document.documentElement.requestFullscreen){
        await document.documentElement.requestFullscreen({navigationUI:'hide'});
        if(screen.orientation && screen.orientation.lock){ screen.orientation.lock('landscape').catch(()=>{}); }
        return;
      }
    }catch(e){}
    if(isIOS()) fsModal.classList.add('show');
    scrollTo(0,1);
  }
  btnFull.addEventListener('click', goFullscreen);
  fsClose.addEventListener('click', ()=> fsModal.classList.remove('show'));

  const en = (el,v=true)=> el.disabled=!v;
  const setState = s => sim.state=s;
  const updatePills = ()=>{ padsPill.textContent=`Parches: ${sim.padsOk?'OK':'Pendiente'}`; safePill.textContent=`Seguridad: ${sim.safe?'OK':'Pendiente'}`; cycleTag.textContent=`Ciclo: ${sim.cycle}`; energyEl.textContent=(sim.state===State.SHOCK_READY||sim.state===State.CHARGING)?`${sim.energy} J`:'—'; };

  /* ===== POWER ===== */
  btnPower.addEventListener('click', ()=>{
    stopAll();
    sim={ ...sim, state:State.WAIT_PADS, cycle:0, padsOk:false, safe:false, firstAnalysis:true, energy:200 };
    en(btnPads,true); en(btnAnalyze,false); en(btnNobody,false); en(btnShock,false); en(btnCPR,false);
    clockEl.textContent='00:00'; updatePills();
    setInstruction('Coloque los parches como se indica y toque “PARCHES OK”.');
    speak('Coloque los parches y confirme parches ok.');
    drawIdle();
  });

  /* ===== PARCHES OK ===== */
  btnPads.addEventListener('click', ()=>{
    if(sim.state!==State.WAIT_PADS) return;
    sim.padsOk=true; updatePills();
    en(btnAnalyze,true);
    setInstruction('Listo. Presione “ANALIZAR”.');
    speak('Parches colocados correctamente. Presione analizar.');
  });

  /* ===== ANALIZAR ===== */
  btnAnalyze.addEventListener('click', ()=>{
    if(sim.state!==State.WAIT_PADS && sim.state!==State.READY) return;
    sim.safe=false; updatePills(); setState(State.ANALYZING);
    en(btnAnalyze,false); en(btnNobody,true); en(btnShock,false); en(btnCPR,false);
    setInstruction('No toque al paciente. Confirme seguridad con “¡NADIE TOQUE!”.');
    speak('No toque al paciente. Confirme nadie toque para iniciar el análisis.');
    drawAnalyzing(false);
  });

  /* ===== ¡NADIE TOQUE! ===== */
  btnNobody.addEventListener('click', ()=>{
    if(sim.state!==State.ANALYZING) return;
    sim.safe=true; updatePills(); en(btnNobody,false);
    setInstruction('Analizando ritmo…'); speak('Analizando ritmo.');
    drawAnalyzing(true);
    clearTimeout(sim.timers.an);
    sim.timers.an=setTimeout(()=>{
      if(sim.firstAnalysis){
        setState(State.CHARGING);
        setInstruction(`Ritmo desfibrilable. Cargando ${sim.energy} J…`);
        speak('Descarga indicada. Cargando.');
        clearTimeout(sim.timers.ch);
        sim.timers.ch=setTimeout(()=>{
          setState(State.SHOCK_READY); en(btnShock,true);
          setInstruction('¡Nadie toque! Presione “SHOCK” ahora.');
          speak('Manténgase alejado. Presione el botón de descarga ahora.');
        },2500);
      }else{
        setState(State.CPR); en(btnCPR,true);
        setInstruction('No se recomienda descarga. Inicie RCP 2:00 (110/min).');
        speak('No se recomienda descarga. Inicie R C P durante dos minutos.');
        drawPostAnalyze();
      }
    },4000);
  });

  /* ===== SHOCK ===== */
  btnShock.addEventListener('click', ()=>{
    if(sim.state!==State.SHOCK_READY) return;
    en(btnShock,false);
    try{ navigator.vibrate && navigator.vibrate([40,40,80]); }catch(e){}
    // WOW flash desde bordes hacia el centro
    flashEl.classList.remove('show'); void flashEl.offsetWidth; flashEl.classList.add('show');
    setInstruction(`Descarga aplicada ${sim.energy} J. Inicie RCP 2:00.`);
    speak('Descarga aplicada. Inicie R C P durante dos minutos.');
    setState(State.CPR); en(btnCPR,true); drawPostShock();
  });

  /* ===== RCP ===== */
  btnCPR.addEventListener('click', ()=>{
    if(sim.state!==State.CPR) return;
    en(btnCPR,false); sim.cycle+=1; updatePills();
    runCPR(120,110,()=>{
      sim.firstAnalysis=false; setState(State.READY); en(btnAnalyze,true);
      setInstruction('Finaliza RCP. Re-analice el ritmo con “ANALIZAR”.');
      speak('Detenga compresiones. Presione analizar.');
      drawIdle();
    });
    setInstruction('RCP en curso 2:00 (110/min).');
  });

  /* ===== RCP temporizador + metrónomo ===== */
  function runCPR(seconds=120,bpm=110,onEnd=()=>{}){
    stopCPR(); let t=seconds; tickClock(t); startMetronome(bpm);
    sim.timers.cpr=setInterval(()=>{ t--; if(t<0){ stopCPR(); onEnd(); return; } tickClock(t); },1000);
  }
  function tickClock(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); clockEl.textContent=`${m}:${ss}`; }
  function stopCPR(){ clearInterval(sim.timers.cpr); stopMetronome(); }

  /* ===== Metronomo WebAudio ===== */
  let audioCtx=null, metroInt=null;
  function startMetronome(bpm=110){
    stopMetronome(); const interval=60000/bpm;
    try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      metroInt=setInterval(()=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.frequency.value=900; g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.22,audioCtx.currentTime+0.005);
        g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.09);
        o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1);
      }, interval);
    }catch(e){}
  }
  function stopMetronome(){ clearInterval(metroInt); }

  /* ===== Canvas EKG ===== */
  const ekg=document.getElementById('ekg'); const g=ekg.getContext('2d');
  function resizeEKG(){ ekg.width=ekg.clientWidth*devicePixelRatio; ekg.height=ekg.clientHeight*devicePixelRatio; }
  addEventListener('resize',resizeEKG); resizeEKG();
  function clearEKG(){ g.clearRect(0,0,ekg.width,ekg.height); cancelAnimationFrame(sim.timers.ekg); }

  function drawIdle(){
    clearEKG(); const mid=ekg.height*0.5; g.strokeStyle='rgba(210,220,240,0.85)'; g.lineWidth=2; let t0=performance.now();
    (function loop(t){ g.fillStyle='rgba(8,16,28,0.18)'; g.fillRect(0,0,ekg.width,ekg.height);
      g.beginPath(); g.moveTo(0,mid);
      for(let x=0;x<ekg.width;x++){ const y=mid+Math.sin((x*0.02)+t*0.8)*ekg.height*0.03; g.lineTo(x,y); }
      g.stroke(); sim.timers.ekg=requestAnimationFrame(loop);
    })(t0);
  }
  function drawAnalyzing(showVF){
    clearEKG(); const W=ekg.width,H=ekg.height,mid=H*0.5; let scanX=0,last=performance.now();
    (function loop(now){
      const dt=(now-last)/1000; last=now;
      g.fillStyle='rgba(8,16,28,0.22)'; g.fillRect(0,0,W,H);
      g.strokeStyle='rgba(40,64,100,0.25)'; g.lineWidth=1;
      for(let x=0;x<W;x+=Math.max(20,W/20)){ g.beginPath(); g.moveTo(x,0); g.lineTo(x,H); g.stroke(); }
      for(let y=0;y<H;y+=Math.max(20,H/12)){ g.beginPath(); g.moveTo(0,y); g.lineTo(W,y); g.stroke(); }
      g.beginPath(); g.lineWidth=2; g.strokeStyle='rgba(230,238,255,0.95)';
      for(let x=0;x<W;x+=3){
        let y; if(showVF){ const f=6+Math.sin(now/500)*2; const amp=H*0.32;
          y=mid+(Math.sin((x*0.02)+now/120*f)+Math.sin((x*0.037)+now/110*f*1.3))*amp*0.35+(Math.random()-0.5)*10;
        } else { y=mid+(Math.random()-0.5)*2; }
        if(x===0) g.moveTo(x,y); else g.lineTo(x,y);
      } g.stroke();
      scanX+=(W*dt)*0.6; if(scanX>W) scanX=0;
      const grd=g.createLinearGradient(scanX-20,0,scanX+20,0);
      grd.addColorStop(0,'rgba(34,211,238,0)'); grd.addColorStop(0.5,'rgba(34,211,238,0.35)'); grd.addColorStop(1,'rgba(34,211,238,0)');
      g.fillStyle=grd; g.fillRect(scanX-20,0,40,H);
      sim.timers.ekg=requestAnimationFrame(loop);
    })(last);
  }
  function drawPostShock(){
    clearEKG(); const W=ekg.width,H=ekg.height; let n=0;
    (function loop(){ g.fillStyle='rgba(8,16,28,1)'; g.fillRect(0,0,W,H);
      for(let i=0;i<80;i++){ const x=Math.random()*W,y=Math.random()*H; g.fillStyle='rgba(255,255,255,0.08)'; g.fillRect(x,y,2,2); }
      n++; if(n<20) sim.timers.ekg=requestAnimationFrame(loop); else drawIdle();
    })();
  }
  function drawPostAnalyze(){ clearEKG(); drawIdle(); }

  function stopAll(){ ['an','ch','cpr'].forEach(k=> (clearInterval(sim.timers[k]), clearTimeout(sim.timers[k]))); stopMetronome(); clearEKG(); }

  // Init
  setInstruction('Encienda el equipo.');
  updatePills();
  drawIdle();
});
</script>
</body>
</html>
