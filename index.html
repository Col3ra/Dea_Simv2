<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>DEA – Prototipo móvil (landscape + fullscreen)</title>
<meta name="theme-color" content="#050915">

<style>
:root{
  --bg:#050915; --panel:#0b1220; --line:#1f2a44; --txt:#e6edf7; --muted:#95a3bd;
  --good:#22c55e; --warn:#ef4444; --accentA:#9b5cf6; --accentB:#22d3ee; --accentC:#00f5a0;
  --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.02);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--txt);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  background: radial-gradient(1200px 800px at 10% -10%, #0b1730 0%, #060b16 50%, var(--bg) 100%),
              linear-gradient(140deg, #07122a 0%, #050915 60%, #04070e 100%);
}

/* Layout principal: optimizado para landscape */
.app{
  min-height:100dvh;
  padding:clamp(8px,1.6vw,16px);
  display:grid;
  grid-template-columns: 1.1fr 1fr;
  grid-template-rows: 1fr;
  gap:clamp(10px,1.6vw,18px);
}

/* Columna izquierda: LCD + indicadores */
.left{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--line); border-radius:18px; padding:14px;
  box-shadow:var(--shadow); position:relative; overflow:hidden;
}
.headerRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1220;color:#cbd5e1}
.lcd{
  font-variant-numeric:tabular-nums;
  font-size:clamp(18px,2.6vw,26px); font-weight:800; letter-spacing:.2px;
  background:linear-gradient(180deg,#0e1a33 0%, #0a1326 60%, #08101d 100%);
  border:1px solid #1d2840; border-radius:14px; padding:16px; min-height:140px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
  display:flex; align-items:center; justify-content:center; text-align:center;
}
.infoRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;color:var(--muted)}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b1220;font-size:13px}
.countdown{font-variant-numeric:tabular-nums;font-weight:900;letter-spacing:.3px;font-size:clamp(18px,2.6vw,26px)}

/* Columna derecha: Botones XL (touch) */
.right{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:var(--shadow);
}
.gridBtns{
  height:100%;
  display:grid; gap:12px;
  grid-template-columns: repeat(2, 1fr);
  grid-auto-rows: 1fr;
}

/* Botones XL con brillo “tech” */
.btn{
  -webkit-tap-highlight-color:transparent; user-select:none; cursor:pointer; border:0;
  padding:16px 14px; border-radius:16px; text-align:center;
  color:#0b1020; font-weight:900; font-size:clamp(16px,2.2vw,22px);
  letter-spacing:.3px; position:relative; overflow:hidden; transform: translateZ(0);
}
.btn .sub{ display:block; font-size:12px; opacity:.9; margin-top:2px; color:#041019 }
.btn:active{ transform: scale(.98) }
.btn[disabled]{ filter:saturate(.4) brightness(.86); opacity:.6; box-shadow:none }

.btn.power   { background: conic-gradient(from 210deg at 30% 0%, #82ffd6 0deg, #3ddcff 120deg, #b694ff 240deg, #82ffd6 360deg); box-shadow: 0 12px 40px rgba(0,245,160,.25) }
.btn.full    { background: linear-gradient(160deg, #9b5cf6, #22d3ee);   box-shadow: 0 12px 40px rgba(155,92,246,.32) }
.btn.pads    { background: linear-gradient(160deg, #7af59a, #22d3ee);   box-shadow: 0 12px 40px rgba(34,211,238,.32) }
.btn.analyze { background: linear-gradient(160deg, #3ddcff, #b694ff);   box-shadow: 0 12px 40px rgba(61,220,255,.28) }
.btn.nobody  { background: linear-gradient(160deg, #ffb4b4, #ff6a6a);   box-shadow: 0 12px 40px rgba(255,90,90,.35) }
.btn.shock   { background: linear-gradient(160deg, #ffe08a, #ff7b00);   box-shadow: 0 12px 40px rgba(255,180,80,.35) }
.btn.cpr     { background: linear-gradient(160deg, #7af59a, #22d3ee);   box-shadow: 0 12px 40px rgba(34,211,238,.32) }

/* Mensaje overlay para orientar a landscape si entran en portrait */
.rotateOverlay{
  position:fixed; inset:0; display:none; place-items:center; z-index:9999;
  background:rgba(5,9,21,.9); color:#fff; text-align:center; padding:24px;
  font-size:clamp(16px,3vw,22px);
}
.rotateOverlay.show{ display:grid }

/* Ajuste si el equipo entra en portrait (fallback) */
@media (orientation: portrait){
  .app{ grid-template-columns: 1fr; grid-template-rows: auto auto }
}
</style>
</head>
<body>
<div class="rotateOverlay" id="rotateOverlay">Girá el teléfono a <b>horizontal</b> para usar el simulador.</div>

<div class="app">
  <!-- Izquierda: estado -->
  <section class="left">
    <div class="headerRow">
      <span class="badge">DEA</span>
      <span class="badge" id="modeTag">Prototipo</span>
      <span class="badge" id="cycleTag">Ciclo: 0</span>
    </div>
    <div class="lcd" id="lcd">Encienda el equipo</div>
    <div class="infoRow">
      <div class="pill" id="padsPill">Parches: —</div>
      <div class="pill" id="safePill">Seguridad: —</div>
      <div class="pill">Energía: <b id="energy">—</b></div>
      <div class="pill countdown" id="clock">00:00</div>
    </div>
  </section>

  <!-- Derecha: botones XL -->
  <section class="right">
    <div class="gridBtns">
      <button class="btn power"   id="btnPower">POWER<span class="sub">Encender / Reiniciar</span></button>
      <button class="btn full"    id="btnFull">FULLSCREEN<span class="sub">Ocultar barras</span></button>

      <button class="btn pads"    id="btnPads" disabled>PARCHES OK<span class="sub">Confirmar colocación</span></button>
      <button class="btn analyze" id="btnAnalyze" disabled>ANALIZAR<span class="sub">Evaluar ritmo</span></button>

      <button class="btn nobody"  id="btnNobody" disabled>¡NADIE TOQUE!<span class="sub">Confirmar seguridad</span></button>
      <button class="btn shock"   id="btnShock" disabled>SHOCK<span class="sub">Aplicar descarga</span></button>

      <button class="btn cpr"     id="btnCPR" disabled>RCP 2:00<span class="sub">Metrónomo 110/min</span></button>
      <!-- Botón libre para futuro uso -->
      <button class="btn" disabled style="opacity:.3;background:linear-gradient(160deg,#1d2435,#121a2a)">—<span class="sub">Reservado</span></button>
    </div>
  </section>
</div>

<script>
/* =====================================================
   DEA – Landscape + Fullscreen + flujo simple
   - Quita colocación visual de parches: ahora "PARCHES OK"
   - Primer análisis: SIEMPRE desfibrilable (shock)
   - Luego: RCP → Reanálisis no desfibrilable
===================================================== */

const $ = s => document.querySelector(s);

// refs UI
const lcd = $('#lcd'), energyEl = $('#energy'), cycleTag = $('#cycleTag');
const btnPower = $('#btnPower'), btnFull = $('#btnFull');
const btnPads = $('#btnPads'), btnAnalyze = $('#btnAnalyze');
const btnNobody = $('#btnNobody'), btnShock = $('#btnShock'), btnCPR = $('#btnCPR');
const padsPill = $('#padsPill'), safePill = $('#safePill'), clockEl = $('#clock');
const rotateOverlay = $('#rotateOverlay');

// estado
const State = { OFF:'off', WAIT_PADS:'wait_pads', ANALYZING:'analyzing', CHARGING:'charging', SHOCK_READY:'shock_ready', CPR:'cpr', READY:'ready' };
let sim = {
  state: State.OFF,
  cycle: 0,
  padsOk: false,
  safe:false,
  firstAnalysis:true,
  energy: 200,
  timers: {an:null, ch:null, cpr:null, metro:null},
};

// ====== orientación: overlay si está en portrait
function checkOrientation(){
  const isPortrait = window.matchMedia('(orientation: portrait)').matches;
  rotateOverlay.classList.toggle('show', isPortrait);
}
checkOrientation();
window.addEventListener('orientationchange', checkOrientation);
window.addEventListener('resize', checkOrientation);

// ====== TTS nativo
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const vs = speechSynthesis.getVoices();
  u.voice = vs.find(v=>v.lang?.startsWith('es')) || null;
  u.lang = u.voice?.lang || 'es-AR'; u.rate = 1; u.pitch = 1;
  try { speechSynthesis.cancel(); speechSynthesis.speak(u); } catch(e){}
}

// ====== Fullscreen + intento de bloqueo a landscape
async function toggleFull(){
  try{
    if (!document.fullscreenElement){
      await document.documentElement.requestFullscreen({navigationUI:"hide"});
      // Intento de bloquear orientación a landscape (soportado en Android Chrome)
      if (screen.orientation && screen.orientation.lock){
        screen.orientation.lock('landscape').catch(()=>{});
      }
      btnFull.querySelector('.sub').textContent = 'Salir de pantalla completa';
    }else{
      await document.exitFullscreen();
      btnFull.querySelector('.sub').textContent = 'Ocultar barras';
    }
  }catch(e){}
}
btnFull.addEventListener('click', toggleFull);

// ====== helpers
function setState(s){ sim.state=s; }
function setEnabled(el, on=true){ el.disabled = !on; }
function updatePills(){
  padsPill.textContent = `Parches: ${sim.padsOk ? 'OK' : 'Pendiente'}`;
  safePill.textContent = `Seguridad: ${sim.safe ? 'OK' : 'Pendiente'}`;
  cycleTag.textContent = `Ciclo: ${sim.cycle}`;
  energyEl.textContent = (sim.state===State.SHOCK_READY || sim.state===State.CHARGING) ? `${sim.energy} J` : '—';
}
function flashLCD(color='#fff59d'){
  const prev = lcd.style.boxShadow;
  lcd.style.boxShadow = `0 0 0 9999px ${color}20 inset, 0 0 30px ${color}`;
  setTimeout(()=> lcd.style.boxShadow = prev, 280);
}

// ====== POWER
btnPower.addEventListener('click', ()=>{
  stopAll();
  sim = { ...sim, state:State.WAIT_PADS, cycle:0, padsOk:false, safe:false, firstAnalysis:true, energy:200 };
  lcd.textContent = 'Presione “PARCHES OK” cuando estén colocados.';
  setEnabled(btnPads,true); setEnabled(btnAnalyze,false); setEnabled(btnNobody,false);
  setEnabled(btnShock,false); setEnabled(btnCPR,false);
  clockEl.textContent = '00:00';
  updatePills();
  speak('Coloque los parches como se indica. Luego confirme parches ok.');
});

// ====== PARCHES OK
btnPads.addEventListener('click', ()=>{
  if(sim.state!==State.WAIT_PADS) return;
  sim.padsOk = true; updatePills();
  lcd.textContent = 'Parches confirmados. Presione ANALIZAR.';
  setEnabled(btnAnalyze,true);
  speak('Parches colocados correctamente. Presione analizar.');
});

// ====== ANALIZAR
btnAnalyze.addEventListener('click', ()=>{
  if(sim.state!==State.WAIT_PADS && sim.state!==State.READY) return;
  sim.safe = false; updatePills();
  setState(State.ANALYZING);
  setEnabled(btnAnalyze,false); setEnabled(btnNobody,true); setEnabled(btnShock,false); setEnabled(btnCPR,false);
  lcd.innerHTML = 'No toque al paciente.<br>Confirme con ¡NADIE TOQUE!';
  speak('No toque al paciente. Confirme nadie toque para iniciar el análisis.');
});

// ====== ¡NADIE TOQUE!
btnNobody.addEventListener('click', ()=>{
  if(sim.state!==State.ANALYZING) return;
  sim.safe = true; updatePills();
  setEnabled(btnNobody,false);
  lcd.textContent = 'Analizando ritmo...';
  speak('Analizando ritmo.');
  clearTimeout(sim.timers.an);
  sim.timers.an = setTimeout(()=>{
    if(sim.firstAnalysis){
      setState(State.CHARGING);
      lcd.innerHTML = `Descarga indicada.<br>Cargando ${sim.energy} J...`;
      speak('Descarga indicada. Cargando.');
      clearTimeout(sim.timers.ch);
      sim.timers.ch = setTimeout(()=>{
        setState(State.SHOCK_READY);
        setEnabled(btnShock,true);
        lcd.innerHTML = 'Manténgase alejado.<br>Presione SHOCK ahora.';
        speak('Manténgase alejado. Presione el botón de descarga ahora.');
      }, 2500);
    }else{
      setState(State.CPR);
      setEnabled(btnCPR,true);
      lcd.innerHTML = 'No se recomienda descarga.<br>Inicie RCP 2:00';
      speak('No se recomienda descarga. Inicie R C P durante dos minutos.');
    }
  }, 4000);
});

// ====== SHOCK
btnShock.addEventListener('click', ()=>{
  if(sim.state!==State.SHOCK_READY) return;
  setEnabled(btnShock,false);
  try{ navigator.vibrate && navigator.vibrate([40,40,80]); }catch(e){}
  flashLCD('#ffd27a');
  lcd.innerHTML = `Descarga aplicada ${sim.energy} J.<br>Inicie RCP 2:00`;
  speak('Descarga aplicada. Inicie R C P durante dos minutos.');
  setState(State.CPR);
  setEnabled(btnCPR,true);
});

// ====== RCP (2:00) + metrónomo 110/min
btnCPR.addEventListener('click', ()=>{
  if(sim.state!==State.CPR) return;
  setEnabled(btnCPR,false);
  sim.cycle += 1; updatePills();
  runCPR(120, 110, ()=>{
    // fin RCP → reanálisis no desfibrilable
    sim.firstAnalysis = false;
    setState(State.READY);
    setEnabled(btnAnalyze,true);
    lcd.innerHTML = 'Re-análisis disponible.<br>Presione ANALIZAR.';
    speak('Detenga compresiones. Presione analizar.');
  });
});

function runCPR(seconds=120, bpm=110, onEnd=()=>{}){
  stopCPR();
  let t = seconds;
  tickClock(t);
  startMetronome(bpm);
  sim.timers.cpr = setInterval(()=>{
    t--;
    if(t<0){
      stopCPR(); onEnd(); return;
    }
    tickClock(t);
  }, 1000);
}
function tickClock(sec){
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  clockEl.textContent = `${m}:${s}`;
}
function stopCPR(){
  clearInterval(sim.timers.cpr);
  stopMetronome();
}

// ====== Metronomo WebAudio
let audioCtx=null, metroInt=null;
function startMetronome(bpm=110){
  stopMetronome();
  const interval = 60000/bpm;
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  metroInt = setInterval(()=>{
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = 900;
    gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.25, audioCtx.currentTime+0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.09);
    osc.connect(gain).connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime+0.1);
  }, interval);
}
function stopMetronome(){ clearInterval(metroInt); }

// ====== Utilidades
function stopAll(){
  ['an','ch','cpr'].forEach(k=> (clearInterval(sim.timers[k]), clearTimeout(sim.timers[k])));
  stopMetronome();
}
// primer tap habilita audio en móviles
window.addEventListener('pointerdown', ()=>{ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }, {once:true});

// init
lcd.textContent = 'Encienda el equipo';
updatePills();
</script>
</body>
</html>